{% extends "admin/master.html" %}
{% import 'admin/lib.html' as lib with context %}

{% macro extra() %}
  <input name="_continue_editing" type="submit" class="btn" value="{{ _gettext('Save and Continue') }}" />
{% endmacro %}

{% block head %}
    {{ super() }}
    {{ lib.form_css() }}
{% endblock %}

{%block body%}
<ul class="nav nav-tabs" role="tablist" id="myTab">
  <li class="active"><a href="#main" role="tab" data-toggle="tab">Camera Status</a></li>
  <li><a href="#init" role="tab" data-toggle="tab">Edit Camera Settings</a></li>
  <li><a href="#run" role="tab" data-toggle="tab">Create Run Settings</a></li>
</ul>

<!-- status Modal -->
<div class="modal fade" id="status-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="myModalLabel">Status Results</h4>
      </div>
      <div class="modal-body text-center" id="status_report">
        <img src="/static/images/ajax-loader.gif">
      </div>
    </div>
  </div>
</div>


<div class="tab-content">

    <div class="tab-pane active" id="main">
        <div id="server_ctl" class="panel
    			{% if status['ok']  %}
				panel-success
			{% else %}
				panel-danger
			{% endif %}
        " style="margin-top: 15px">
        	<div class="panel-heading"><div class="panel-title">PhenoCam Status and Control</div></div>
        	<div class="panel-body">
        		<div id='server_status' class='pull-left'>
        				<span class="glyphicon glyphicon-ok"></span>
        				<span class="status_msg">&nbsp;{{ status['msg']  }}</span>	
        		</div>
        		<div id='server_ctl_btns'  class='pull-right'>
        				<a class="btn btn-primary" href="/phenocam/?action=reinit"><span class="glyphicon glyphicon-wrench"></span> Initalize</a>
                              <a  class="btn btn-primary" data-toggle="modal" data-target="#status-modal"><span class="glyphicon glyphicon-tasks"></span> Status</a>
        				<a class="btn btn-primary" href="/phenocam/?action=test"><span class="glyphicon glyphicon-picture"></span> Test</a>
        		</div>
        	</div>
        </div>
        
    </div>
    
    <div class="tab-pane" id="init">
        <h4/> PhenoCam Initalizaton Settings </h4>
            {% call lib.form_tag(init_form) %}
                {{ lib.render_form_fields(init_form, form_opts=form_opts) }}
                {{ lib.render_form_buttons(return_url, extra()) }}
            {% endcall %}
    </div>
    
    <div class="tab-pane" id="run">
        <h4> Create PhenoCam Run Settings </h4>
            {% call lib.form_tag(run_list) %}
                {{ lib.render_form_fields(run_list, form_opts=list_opts) }}
            {% endcall %}
            {% call lib.form_tag(run_form) %}
                {{ lib.render_form_fields(run_form, form_opts=form_opts) }}
                {{ lib.render_form_buttons(return_url, extra()) }}
            {% endcall %}
    </div>

</div>
{% endblock %}

{% block tail %}
  {{ super() }}
  {{ lib.form_js() }}

<script>

  $(function () {
    $('#myTab a[href="#{{active_tab}}"]').tab('show')
  })

  //flag to tell if we are waiting on a callback
  var status_modal_call = false
  // send call to run test, dont re-call if still waiting on previous
  $('#status-modal').on('show.bs.modal', function()
    {
        if (!status_modal_call){
            status_modal_call = true
            $('#status_report').prepend("<h4>Waiting for camera status....</h4>")
            $.get('/phenocam?action=status', function(data)
                {
                  $('#status_report').html(data) 
                  status_modal_call=false 
                }
            )         
        }
    }
  )
  //let the modal hide but dont reset it if call hasn't returned
  $('#status-modal').on('hide.bs.modal', function()
    {
        if(!status_modal_call){
            $('#status_report').html("<img src='/static/images/ajax-loader.gif'>")
        }
    }

  )
</script>
{% endblock %}